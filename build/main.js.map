{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v3.1.2\n */\n\n// The adapter-core module gives you access to the core ioBroker functions\n// you need to create an adapter\nimport * as utils from '@iobroker/adapter-core';\n\nimport VerisureClient from 'verisure';\n\ntype VerisureClientType = {\n\tgetToken: (code?: string) => Promise<unknown>;\n\tgetInstallations: () => Promise<Array<{ giid: string; client: (request: unknown) => Promise<any> }>>;\n};\n\nclass Verisure extends utils.Adapter {\n\tprivate pollTimer: ioBroker.Interval | undefined;\n\tprivate client: VerisureClientType | undefined;\n\tprivate refreshPromise: Promise<void> | undefined;\n\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({\n\t\t\t...options,\n\t\t\tname: 'verisure',\n\t\t});\n\t\tthis.on('ready', this.onReady.bind(this));\n\t\tthis.on('stateChange', this.onStateChange.bind(this));\n\t\t// this.on('objectChange', this.onObjectChange.bind(this));\n\t\t// this.on('message', this.onMessage.bind(this));\n\t\tthis.on('unload', this.onUnload.bind(this));\n\t}\n\n\t/**\n\t * Is called when databases are connected and adapter received configuration.\n\t */\n\tprivate async onReady(): Promise<void> {\n\t\tif (!this.config.email || !this.config.password) {\n\t\t\tthis.log.error('Email and password are required in adapter configuration');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.client = new VerisureClient(this.config.email, this.config.password) as unknown as VerisureClientType;\n\n\t\tawait this.syncDevices();\n\n\t\tconst intervalMs = Math.max(30, this.config.pollInterval || 300) * 1000;\n\t\tthis.pollTimer = this.setInterval(() => this.syncDevices(), intervalMs);\n\t}\n\n\t/**\n\t * Is called when adapter shuts down - callback has to be called under any circumstances!\n\t *\n\t * @param callback - Callback function\n\t */\n\tprivate onUnload(callback: () => void): void {\n\t\ttry {\n\t\t\tif (this.pollTimer) {\n\t\t\t\tthis.clearInterval(this.pollTimer);\n\t\t\t}\n\n\t\t\tcallback();\n\t\t} catch (error) {\n\t\t\tthis.log.error(`Error during unloading: ${(error as Error).message}`);\n\t\t\tcallback();\n\t\t}\n\t}\n\n\t// If you need to react to object changes, uncomment the following block and the corresponding line in the constructor.\n\t// You also need to subscribe to the objects with `this.subscribeObjects`, similar to `this.subscribeStates`.\n\t// /**\n\t//  * Is called if a subscribed object changes\n\t//  */\n\t// private onObjectChange(id: string, obj: ioBroker.Object | null | undefined): void {\n\t// \tif (obj) {\n\t// \t\t// The object was changed\n\t// \t\tthis.log.info(`object ${id} changed: ${JSON.stringify(obj)}`);\n\t// \t} else {\n\t// \t\t// The object was deleted\n\t// \t\tthis.log.info(`object ${id} deleted`);\n\t// \t}\n\t// }\n\n\t/**\n\t * Is called if a subscribed state changes\n\t *\n\t * @param id - State ID\n\t * @param state - State object\n\t */\n\tprivate onStateChange(id: string, state: ioBroker.State | null | undefined): void {\n\t\tif (state) {\n\t\t\t// The state was changed\n\t\t\tthis.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\n\t\t} else {\n\t\t\t// The object was deleted or the state value has expired\n\t\t\tthis.log.info(`state ${id} deleted`);\n\t\t}\n\t}\n\t// If you need to accept messages in your adapter, uncomment the following block and the corresponding line in the constructor.\n\t// /**\n\t//  * Some message was sent to this instance over message box. Used by email, pushover, text2speech, ...\n\t//  * Using this method requires \"common.messagebox\" property to be set to true in io-package.json\n\t//  */\n\t//\n\t// private onMessage(obj: ioBroker.Message): void {\n\t// \tif (typeof obj === 'object' && obj.message) {\n\t// \t\tif (obj.command === 'send') {\n\t// \t\t\t// e.g. send email or pushover or whatever\n\t// \t\t\tthis.log.info('send command');\n\t// \t\t\t// Send response in callback if required\n\t// \t\t\tif (obj.callback) this.sendTo(obj.from, obj.command, 'Message received', obj.callback);\n\t// \t\t}\n\t// \t}\n\t// }\n\n\tprivate async syncDevices(): Promise<void> {\n\t\tif (!this.client) return;\n\n\t\ttry {\n\t\t\tif (!this.refreshPromise) {\n\t\t\t\tthis.refreshPromise = this.client\n\t\t\t\t\t.getToken()\n\t\t\t\t\t.then(() => undefined)\n\t\t\t\t\t.catch((err: Error) => {\n\t\t\t\t\t\tthis.log.error(`Failed to refresh token: ${err.message}`);\n\t\t\t\t\t\tthrow err;\n\t\t\t\t\t})\n\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\tthis.refreshPromise = undefined;\n\t\t\t\t\t});\n\t\t\t}\n\t\t\tawait this.refreshPromise;\n\n\t\t\tconst installations = await this.client.getInstallations();\n\n\t\t\tfor (const installation of installations) {\n\t\t\t\tconst client = installation.client.bind(installation);\n\n\t\t\t\tconst overview = await client({\n\t\t\t\t\toperationName: 'overview',\n\t\t\t\t\tvariables: { giid: installation.giid },\n\t\t\t\t\tquery: `query overview($giid: String!) {\n\t\t\t\t\t\tinstallation(giid: $giid) {\n\t\t\t\t\t\t\tdoorlocks {\n\t\t\t\t\t\t\t\tdeviceLabel\n\t\t\t\t\t\t\t\tarea\n\t\t\t\t\t\t\t\tdoorLockState\n\t\t\t\t\t\t\t\tdeviceId\n\t\t\t\t\t\t\t\t__typename\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcameras {\n\t\t\t\t\t\t\t\tdeviceLabel\n\t\t\t\t\t\t\t\tarea\n\t\t\t\t\t\t\t\tisOnline\n\t\t\t\t\t\t\t\tdeviceId\n\t\t\t\t\t\t\t\timage {\n\t\t\t\t\t\t\t\t\thighResolutionUrl\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t__typename\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t__typename\n\t\t\t\t\t\t}\n\t\t\t\t\t}`,\n\t\t\t\t});\n\n\t\t\t\tconst baseId = `installations.${installation.giid}`;\n\n\t\t\t\tif (overview.installation?.doorlocks) {\n\t\t\t\t\tfor (const lock of overview.installation.doorlocks) {\n\t\t\t\t\t\tconst uniqueKey = `${lock.deviceLabel || 'lock'}_${lock.area || 'unknown'}_${lock.deviceId || 'id'}`;\n\t\t\t\t\t\tconst id = `${baseId}.doorlocks.${this.sanitizeId(uniqueKey)}`;\n\t\t\t\t\t\tawait this.extendObjectAsync(id, {\n\t\t\t\t\t\t\ttype: 'state',\n\t\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\t\tname: lock.deviceLabel,\n\t\t\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\t\t\trole: 'state',\n\t\t\t\t\t\t\t\tread: true,\n\t\t\t\t\t\t\t\twrite: false,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tnative: {},\n\t\t\t\t\t\t});\n\t\t\t\t\t\tawait this.setState(id, { val: lock.doorLockState, ack: true });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (overview.installation?.cameras) {\n\t\t\t\t\tfor (const camera of overview.installation.cameras) {\n\t\t\t\t\t\tconst uniqueKey = `${camera.deviceLabel || 'camera'}_${camera.area || 'unknown'}_${camera.deviceId || 'id'}`;\n\t\t\t\t\t\tconst id = `${baseId}.cameras.${this.sanitizeId(uniqueKey)}`;\n\t\t\t\t\t\tawait this.extendObjectAsync(id, {\n\t\t\t\t\t\t\ttype: 'state',\n\t\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\t\tname: camera.deviceLabel,\n\t\t\t\t\t\t\t\ttype: 'boolean',\n\t\t\t\t\t\t\t\trole: 'indicator.reachable',\n\t\t\t\t\t\t\t\tread: true,\n\t\t\t\t\t\t\t\twrite: false,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tnative: {},\n\t\t\t\t\t\t});\n\t\t\t\t\t\tawait this.setState(id, { val: !!camera.isOnline, ack: true });\n\n\t\t\t\t\t\tif (camera.image?.highResolutionUrl) {\n\t\t\t\t\t\t\tconst imageId = `${id}.imageUrl`;\n\t\t\t\t\t\t\tawait this.extendObjectAsync(imageId, {\n\t\t\t\t\t\t\t\ttype: 'state',\n\t\t\t\t\t\t\t\tcommon: {\n\t\t\t\t\t\t\t\t\tname: `${camera.deviceLabel} image`,\n\t\t\t\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\t\t\t\trole: 'url',\n\t\t\t\t\t\t\t\t\tread: true,\n\t\t\t\t\t\t\t\t\twrite: false,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tnative: {},\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tawait this.setState(imageId, { val: camera.image.highResolutionUrl, ack: true });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.log.error(`Failed to sync devices: ${(error as Error).message}`);\n\t\t}\n\t}\n\n\tprivate sanitizeId(label: string): string {\n\t\tconst sanitized = label\n\t\t\t.replace(/[^a-zA-Z0-9-_]/g, '_')\n\t\t\t.replace(/_+/g, '_')\n\t\t\t.replace(/^_+|_+$/g, '');\n\t\treturn sanitized || 'unknown';\n\t}\n}\nif (require.main !== module) {\n\t// Export the constructor in compact mode\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Verisure(options);\n} else {\n\t// otherwise start the instance directly\n\t(() => new Verisure())();\n}\n"],
  "mappings": "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",
  "names": ["VerisureClient"]
}
